# Efeitos do Plano Amostral {#epa}

## Introdução {#secC4N1}
<div style="text-align: justify">

A estimação do desvio ou erro padrão de estimativas, de intervalos de confiança e o uso de testes de hipóteses desempenham papel fundamental em estudos analíticos. Além de estimativas pontuais, na inferência analítica é necessário conhecer e comunicar a precisão associada às estimativas e construir intervalos de confiança para os parâmetros de interesse. Valores de desvios padrões, ou alternativamente margens de erro iguais à semiamplitude de intervalos de confiança, permitem avaliar a precisão da estimação. Em muitos casos, a estimação do desvio padrão ou da variância também possibilita a construção de estatísticas para testar hipóteses relativas aos parâmetros do modelo (tradição de modelagem) ou aos parâmetros da população finita (tradição de amostragem). Testes de hipóteses são também usados na fase de seleção de variáveis ou efeitos para inclusão ou manutenção nos modelos ajustados.

Os sistemas mais comuns de análise estatística incluem em suas saídas valores de estimativas pontuais e seus desvios padrões, intervalos de confiança e valores-$p$ relativos a hipóteses de interesse. Contudo, as fórmulas usadas nestes sistemas para a estimação dos desvios padrões e obtenção de estatísticas de testes são, em geral, baseadas nas hipóteses de independência e de igualdade de distribuição (IID) das observações ou, equivalentemente, do emprego de Amostragem Aleatória Simples Com Reposição - AASC. Tais hipóteses quase nunca valem para dados obtidos através de pesquisas por amostragem, como as que realizam o IBGE e outras agências produtoras de estatísticas públicas e/ou oficiais. Os principais motivos para isso são o emprego de estratificação, conglomeração, planos amostrais com probabilidades desiguais de seleção e correções para não resposta, que dão origem a observações amostrais com pesos distintos, e/ou que não são independentes quando provenientes dos mesmos grupos usados como conglomerados nalguma das etapas de amostragem.

Este capítulo trata de como avaliar o impacto sobre estimativas de desvios padrões, intervalos de confiança e níveis de significância de testes usuais quando há afastamentos das hipóteses IID mencionadas, devidos ao uso de planos amostrais complexos para obter os dados. Como veremos, o impacto pode ser muito grande em algumas situações, justificando os cuidados que devem ser tomados na análise de dados provenientes de amostras complexas. Neste capítulo, usamos como referência básica @Sk89a.


## Efeito do Plano Amostral - EPA de Kish {#secC4N2}
<div style="text-align: justify">

Para medir o efeito do plano amostral sobre a variância de um estimador, @Kish65 propôs uma medida que denominou **Efeito do Plano Amostral** - $EPA$ (em inglês, *design effect* ou, abreviadamente, *deff*). O objetivo desta medida é comparar planos amostrais no estágio de planejamento da pesquisa. O $EPA$ de Kish é uma razão entre variâncias (de aleatorização) de um estimador, calculadas para dois planos amostrais alternativos. Vamos considerar um estimador $\hat{\theta}$ para um parâmetro único $\theta$ e calcular a variância de sua distribuição induzida pelo plano amostral complexo (verdadeiro) $V_{VERD}\left(\hat{\theta}\right)$ e a variância da distribuição do estimador induzida pelo plano de amostragem aleatória simples $V_{AAS}\left(\hat{\theta}\right)$. Nessa comparação, está implícita a ideia de que o estimador $\hat{\theta}$ é não enviesado ou ao menos consistente para o parâmetro $\theta$ tanto sob o plano amostral complexo como sob AAS.

\BeginKnitrBlock{definition}
<span class="definition" id="def:unnamed-chunk-1"><strong>(\#def:unnamed-chunk-1) </strong></span>O **Efeito do Plano Amostral -$EPA$ de Kish** para um estimador $\hat{\theta}$ é
\EndKnitrBlock{definition}

\begin{equation}
EPA_{Kish} \left(\hat{\theta}\right) = \frac{V_{VERD} \left(\hat{\theta}\right)} {V_{AAS} \left(\hat{\theta}\right)} \quad (\#eq:eqC4N1)
\end{equation}


Para ilustrar o conceito do $EPA_{Kish}\left(\hat{\theta}\right)$, vamos considerar um exemplo.

\BeginKnitrBlock{example}
<span class="example" id="exm:exC4N1"><strong>(\#exm:exC4N1) </strong></span>Efeitos de plano amostral de Kish para estimadores de totais com amostragem conglomerada em dois estágios.
\EndKnitrBlock{example}

@SilvaMou estimaram o $EPA_{Kish}$ para estimadores de totais de várias variáveis socioeconômicas no nível das Regiões Metropolitanas - RMs - utilizando dados do questionário de amostra do Censo Demográfico de 1980. Essas medidas estimadas do efeito do plano amostral foram calculadas para três estratégias amostrais alternativas, todas considerando amostragem conglomerada de domicílios em dois estágios, tendo o setor censitário como unidade primária de amostragem - UPA - e o domicílio como unidade secundária de amostragem - USA. Duas das alternativas consideraram seleção de setores com equiprobabilidade via amostragem aleatória simples sem reposição - AC2AAS - e fração amostral constante de domicílios no segundo estágio (uma usando o estimador HT do total, e outra usando o estimador de razão para o total calibrando no número total de domicílios da população). Uma terceira estratégia, denominada AC2PPT, considerou a seleção de setores com probabilidades proporcionais ao tamanho - PPT - usando o número de domicílios por setor como medida de tamanho, a seleção de $15$ domicílios em cada setor da amostra usando AAS e empregando o correspondente estimador HT.

A título de ilustração, resultados referentes à Região Metropolitana do Rio de Janeiro são apresentados na Tabela \@ref(tab:tabC4N1) para algumas variáveis. Note que a população-alvo para a qual se faz inferência considera apenas moradores em domicílios particulares permanentes na Região Metropolitana do Rio de Janeiro.

\begin{table}[H]

\caption{(\#tab:tabC4N1)\centering $\text{Efeitos de plano amostral de Kish para variáveis selecionadas}$ \newline $\text{Região Metropolitana do Rio de Janeiro}$}
\centering
\begin{tabular}[t]{>{\raggedright\arraybackslash}p{6cm}>{\raggedleft\arraybackslash}p{3cm}>{\raggedleft\arraybackslash}p{3cm}>{\raggedleft\arraybackslash}p{3.5cm}}
\toprule
Variável & AC2AAS + Estimador HT & AC2AAS + Estimador de Razão & AC2PPT + Estimador HT\\
\midrule
1. Número total de moradores & 10,74 & 2,00 & 1,90\\
2. Número de moradores ocupados & 5,78 & 1,33 & 1,28\\
3. Rendimento monetário mensal & 5,22 & 4,92 & 4,49\\
4. Número total de filhos nascidos vivos de mulheres com 15 anos ou mais & 4,59 & 2,02 & 1,89\\
5. Número de domicílios que têm fogão & 111,27 & 1,58 & 1,55\\
\addlinespace
6. Número de domicílios que têm telefone & 7,11 & 7,13 & 6,41\\
7. Valor do aluguel ou prestação mensal & 7,22 & 7,02 & 6,45\\
8. Número de domicílios que têm automóvel e renda < 5SM & 1,80 & 1,67 & 1,55\\
9. Número de domicílios que têm geladeira e renda $\geq$ 5SM & 46,58 & 2,26 & 2,08\\
\bottomrule
\end{tabular}
\end{table}


Os valores apresentados na Tabela \@ref(tab:tabC4N1) para a RM do Rio de Janeiro são similares aos observados para as demais RMs, se consideradas as mesmas variáveis, conforme os resultados obtidos por @SilvaMou. Nota-se grande variação dos valores do $EPA_{Kish}$ cujos valores mínimo e máximo são de 1,28 e 111,27 respectivamente. Porém, em todos os casos, os valores dos $EPA_{Kish}$ são maiores que $1$, indicando que as três estratégias consideradas levariam a estimativas menos precisas que as que poderiam ser obtidas usando AAS com os mesmos tamanhos de amostra. Quanto maior o valor do $EPA_{Kish}$, menor a precisão das estimativas obtidas com cada estratégia em comparação com a de uma AAS de igual tamanho.

Os valores elevados do $EPA_{Kish}$ observados para algumas variáveis realçam a importância de considerar o plano amostral verdadeiro ao estimar variâncias e desvios padrões associados às estimativas pontuais. Isso ocorre porque estimativas ingênuas de variância baseadas na hipótese de AASC podem subestimar as variâncias corretas com viés substancial.

Uma outra análise revela que, para algumas variáveis (1, 2, 4, 5 e 9), o $EPA_{Kish}$ varia consideravelmente entre as diferentes estratégias, enquanto para outras variáveis (3, 6, 7 e 8) as variações entre as estratégias é pequena. Esta análise ilustra o uso pretendido por @Kish65, qual seja o de permitir comparar estratégias de amostragem em etapas de planejamento de pesquisas por amostragem, usando a precisão da AAS como marco de referência para estratégias alternativas sendo consideradas.

Outra regularidade encontrada nesse valores é que o $EPA_{Kish}$ para a estratégia que usa o plano amostral AC2AAS com o estimador HT apresenta sempre os valores mais elevados, revelando que esta estratégia é menos eficiente que as duas competidoras consideradas. Em geral, o $EPA_{Kish}$ é menor para a estratégia AC2PPT com o correspondente estimador HT, com valores próximos aos da estratégia AC2AAS com estimador de razão.

Os valores dos $EPA_{Kish}$ calculados por @SilvaMou podiam ser usados para planejar pesquisas amostrais (ao menos nas regiões metropolitanas), pois permitiam comparar e antecipar o impacto do uso de algumas estratégias amostrais alternativas sobre a precisão de estimadores de totais de várias variáveis relevantes. Permitiam também calcular tamanhos amostrais para garantir determinado nível de precisão, sem emprego de fórmulas complicadas, como discutido, por exemplo, em @Silva2020, seção 12.10.4. Portanto, tais valores seriam úteis como informação de apoio ao planejamento de novas pesquisas por amostragem, antes que as respectivas amostras fossem efetivamente selecionadas.

Entretanto, esses valores teriam pouca utilidade em termos de usos analíticos dos dados da amostra do Censo Demográfico 1980 - CD80. É que tais valores, embora tendo sido estimados com essa amostra, foram calculados para planos amostrais distintos do que foi efetivamente adotado para seleção da amostra daquele censo.

A amostra de domicílios usada no CD80 foi estratificada por setor censitário com seleção sistemática de uma fração fixa (1/4 ou 25%) dos domicílios de cada setor. Já os planos amostrais considerados por @SilvaMou na estimação dos $EPA_{Kish}$ que apresentaram eram planos amostrais em dois estágios, com seleção de setores no primeiro estágio, e domicílios no segundo estágio. Tais planos foram considerados por sua similaridade com os planos amostrais adotados nas principais pesquisas domiciliares do IBGE, tais como a PNAD e a Pesquisa Mensal de Emprego - PME. Portanto, a utilidade maior dos valores tabulados dos $EPA_{Kish}$ seria a comparação de planos amostrais alternativos para planejamento de pesquisas futuras, e não a análise dos resultados da amostra do CD80.

## Efeito do Plano Amostral Ampliado {#secC4N3}
<div style="text-align: justify">

O que se observou no Exemplo \@ref(exm:exC4N1) com respeito à dificuldade ou mesmo impossibilidade de uso dos $EPA_{Kish}$ calculados para fins analíticos também se aplica para outras situações e é uma deficiência estrutural do conceito de EPA proposto por @Kish65. Para tentar contornar essa dificuldade, é necessário considerar um conceito ampliado de EPA, correspondente ao conceito de *misspecification effect* - `meff` - proposto por @SHS89 na p. 24, que apresentamos e discutimos nesta seção.

Para introduzir este conceito ampliado de EPA, que tem utilidade também para fins de inferência analítica, vamos agora considerar um modelo subjacente às observações usadas para o cálculo do estimador pontual $\hat{\theta}$ para um parâmetro único $\theta$. Designemos por $v_{0} = \widehat{V}_{IID} \left(\hat{\theta}\right)$ um estimador usual (consistente) da variância de $\hat{\theta}$ calculado sob a hipótese (ingênua) de que as observações da amostra disponível são IID. A inadequação da hipótese de IID poderia ser consequência ou da estrutura da população ou do efeito de um plano amostral complexo, ou ambos. Em qualquer dos casos, a estimativa $v_{0}$ da variância de $\hat{\theta}$ calculada sob a hipótese de observações IID se afastaria da variância de $\hat{\theta}$ sob o plano amostral (ou modelo) verdadeiro, denotada $V_{VERD}\left(\hat{\theta}\right)$. Note que $V_{VERD}\left(\hat{\theta}\right) = V_{M}\left(\hat{\theta}\right)$ na abordagem baseada em modelos e $V_{VERD}\left(\hat{\theta}\right) = V_{p}\left(\hat{\theta}\right)$ na abordagem de aleatorização, onde o plano amostral $p$ considerado é diferente de AASC.

Para avaliar se este afastamento tende a ser grande ou pequeno, vamos considerar a distribuição de $v_{0}$ com relação à distribuição de aleatorização verdadeira (ou do modelo verdadeiro) e localizar $v_{0}$ com relação a esta distribuição de referência. Como em geral seria complicado obter esta distribuição, vamos tomar uma medida de centro ou locação da distribuição de $v_{0}$ e compará-la ao valor de $V_{VERD}\left(\hat{\theta}\right)$.

Podemos desta forma introduzir uma medida de efeito da especificação incorreta do plano amostral (ou do modelo) sobre a estimativa $v_{0}$ da variância do estimador $\hat{\theta}$.


\BeginKnitrBlock{definition}
<span class="definition" id="def:unnamed-chunk-2"><strong>(\#def:unnamed-chunk-2) </strong></span>O efeito da especificação incorreta do plano amostral (ou do modelo) sobre a estimativa $v_{0}$ da variância do estimador $\hat{\theta}$ é
\EndKnitrBlock{definition}

\begin{equation}
EPA \left(\hat{\theta}, v_{0}\right) = \frac{V_{VERD}\left(\hat{\theta}\right)} {E_{VERD}\left(v_{0}\right)} \quad(\#eq:eqC4N2)
\end{equation}

Desta forma, o $EPA\left(\hat{\theta}, v_{0}\right)$ mede a tendência de $v_{0}$ a subestimar ou superestimar $V_{VERD}\left(\hat{\theta}\right)$, variância *verdadeira* de $\hat{\theta}$. Valores de $EPA\left(\hat{\theta}, v_{0}\right)$ maiores que $1$ sinalizam que $v_{0}$ tende a subestimar a variância $V_{VERD}\left(\hat{\theta}\right)$. Quanto mais afastado de $1$ for o valor de $EPA\left(\hat{\theta}, v_{0}\right)$, mais incorreta será considerada a especificação do plano amostral ou do modelo considerado.

Enquanto a medida proposta por @Kish65 baseia-se nas distribuições induzidas pela aleatorização dos planos amostrais comparados, o $EPA\left(\hat{\theta}, v_{0}\right)$ pode ser calculado com respeito a distribuições de aleatorização ou do modelo envolvido, bastando calcular $V_{VERD}$ e $E_{VERD}$ da definição \@ref(eq:eqC4N2) com relação à distribuição de referência correspondente.

Em geral, são esperadas as seguintes consequências sobre o $EPA$ ao ignorar o plano amostral efetivamente adotado e admitir que a seleção da amostra foi AASC:


1.  Ignorar os pesos em $v_{0}$ pode inflacionar o $EPA$;

2.  Ignorar conglomeração em $v_{0}$ pode inflacionar o $EPA$;

3.  Ignorar estratificação em $v_{0}$ pode reduzir o $EPA$.


Combinações destes aspectos num mesmo plano amostral complexo, resultando na especificação incorreta do plano amostral como se fosse AASC ou da hipótese de observações IID que levam ao estimador ingênuo de variância $v_{0}$, podem inflacionar ou reduzir o $EPA$. Nesses casos é difícil prever o impacto de ignorar o plano amostral (ou modelo) verdadeiro sobre a análise baseada em hipóteses IID. Por essa razão, é recomendável ao menos estimar os $EPA$ antes de concluir a análise padrão, para então poder avaliar se há impactos importantes a considerar.

Embora pensadas com objetivos distintos, as duas definições de EPA consideradas têm em comum a ideia de que são medidas adimensionais, estabelecidas mediante comparação de um valor de interesse - $V_{VERD}\left(\hat{\theta}\right)$ - com valores de referência - $V_{AAS}\left(\hat{\theta}\right)$ ou $E_{VERD}\left(v_{0}\right)$ - que nos servem de baliza para avaliar o resultado, por serem quantidades habitualmente usadas ou fáceis de calcular. Essa ideia é recorrente na Estatística, de buscar referir quantidades novas a valores ou distribuições de referência conhecidos, como veremos na sequência deste livro.

Apesar dessa diferença de conceitos do EPA de Kish e do EPA ampliado, na prática vai quase sempre ser necessário estimar valores de EPA usando dados de uma amostra. O estimador habitualmente usado para os dois tipos de EPA será então o mesmo, dado por:

\begin{equation}
\widehat{EPA} \left(\hat{\theta},v_{0}\right) = \frac{\widehat{V}_{VERD}\left(\hat{\theta}\right)} {v_{0}} \quad  (\#eq:eqC4N3)
\end{equation}

onde o numerador é um estimador não viciado (ou ao menos consistente) para a verdadeira variância do estimador sob o plano amostral de fato empregado para obter a amostra usada na inferência, e no denominador usamos a ideia de que a estimativa $v_{0}$ obtida na amostra é não viciada para estimar o valor esperado dessa quantidade aleatória sob o plano amostral de fato empregado na obtenção da amostra. Apesar de resultar numa estimativa de EPA idêntica para os dois conceitos, a interpretação do resultado será bastante distinta dependendo de qual dos dois parâmetros se buscava estimar. No caso do EPA de Kish ser o alvo, o interesse seria pela comparação de eficiência relativa entre o plano amostral efetivamente empregado e AAS. No caso do EPA ampliado ser o alvo, o interesse é em avaliar quão viciada pode ser a aplicação de métodos padrões de forma ingênua para estimar a variância de estimadores dos parâmetros de interesse da análise.

\BeginKnitrBlock{example}
<span class="example" id="exm:exC4N2"><strong>(\#exm:exC4N2) </strong></span>Efeitos de plano amostral para estimação de médias na amostragem estratificada simples com alocação desproporcional
\EndKnitrBlock{example}

Neste exemplo consideramos uma população de $N=749$ empresas, para as quais foram observadas as seguintes variáveis:

1. pessoal ocupado em 31/12/1994 - PO;

2. total de salários pagos no ano de 1994 - SAL;

3. receita total no ano de 1994 - REC.

A ideia é considerar o problema de estimar as médias populacionais das variáveis SAL e REC (variáveis de pesquisa consideradas neste exemplo), usando amostras estratificadas simples com alocação desproporcional, implicando em unidades amostrais com pesos desiguais numa situação bastante simples. A variável PO é a variável de estratificação. Como temos dados de todas as empresas da população, as médias populacionais das variáveis de pesquisa são conhecidas. Entretanto, para efeitos do presente exemplo, vamos supor que seriam desconhecidas e que amostragem seria usada para sua estimação.

Para estimar estas médias, as empresas da população foram divididas em dois estratos, definidos a partir da variável PO, conforme indicado na Tabela \@ref(tab:tabC4N2).

\begin{table}[H]

\caption{(\#tab:tabC4N2)$\text{Definição da estratificação da população de empresas}$}
\centering
\begin{tabular}[t]{ccc}
\toprule
Estrato & Condição & Tamanho\\
\midrule
1 & empresas com PO  $>21$ & $161$ empresas\\
2 & empresas com PO $\leq21$ & $588$ empresas\\
\bottomrule
\end{tabular}
\end{table}


A ideia seria então selecionar, de cada um dos estratos, amostras aleatórias simples sem reposição de tamanhos $n_h = 30$ empresas, implicando em uso de *alocação igual* e em frações amostrais desiguais, em vista dos diferentes tamanhos populacionais dos estratos. Como o estrato 1 contém cerca de $21\%$ das observações da população, a proporção de $50\%$ das observações *da amostra total* sendo alocada no estrato 1 (das maiores empresas) da amostra é bem maior do que seria esperado sob amostragem aleatória simples da população de empresas.

Em consequência, a média amostral simples $\overline{y}$ de qualquer das duas variáveis de pesquisa (SAL ou REC) dada por

$$
\overline{y} = \frac{1}{n} \sum \limits_{h=1}^{2} \sum_{i \in s_h} y_i = \sum \limits_{h=1}^{2} \frac{n_h}{n} \overline{y}_h
$$
tenderia a superestimar a média populacional $\overline{Y}$ correspondente dada por

$$\overline{Y} = \frac{1}{N} \sum\limits_{h=1}^{2} \sum_{i \in U_{h}} y_{i} = \sum \limits_{h=1}^{2} \frac{N_h}{N} \overline{Y}_h$$

onde:   

*   $y_{i}$ é o valor da variável de pesquisa $y$, $y \in \{SAL; REC\}$, para a $i-$ésima observação;

*   $n$ é o tamanho total da amostra;

*   $N$ o tamanho total da população;

*   $s_h$ e $U_h$ representam os conjuntos de unidades na amostra e na população do estrato $h$ respectivamente;

*   $n_h$ é o número de unidades na amostra do estrato $h$;

*   $N_h$ é o número de unidades na população do estrato $h$;

*   $\overline{y}_{h} = \frac{1}{n_{h}} \sum_{i \in s_h} y_i$ é a média dos $y^{\prime}s$ na amostra no estrato $h \in \{1; 2\}$ e

*   $\overline{Y}_h = \frac{1}{N_h} \sum_{i \in U_h} y_i$ é a média populacional dos $y^{\prime}s$ no estrato $h \in \{1; 2\}$.


É fácil verificar que o vício do estimador $\overline{y}$ para a média populacional $\overline{Y}$ é dado por:

$$
B_{AES}(\overline{y}) = \sum\limits_{h=1}^{2} \left( \frac{n_h}{n} - \frac{N_h}{N} \right) \overline{Y}_h
$$
É fácil notar que sob alocação proporcional da amostra estratificada o vício seria nulo, o que não ocorre no presente exemplo. Como aqui a amostra estratificada carrega proporcionalmente mais unidades do estrato de maiores empresas, o valor deste viés será positivo. De fato, o valor exato deste vício pode ser calculado no presente exemplo onde conhecemos todos os dados das unidades da população.

Para amostras estratificadas simples como a considerada neste exemplo, o estimador não viciado tipo Horvitz-Thompson da média populacional $\overline{Y}$ seria dado por

$$
\overline{y}_w = \sum\limits_{h=1}^2 W_h \overline{y}_h = \frac{1}{N} \sum\limits_{h=1}^2 \sum_{i \in s_h} \frac{N_h}{n_h} y_i
$$
onde $W_h = N_h / N$ é a proporção de unidades da população no estrato $h \in \{1; 2\}$.

Com a finalidade de ilustrar o cálculo do $EPA$, vamos considerar o estimador não viciado $\overline{y}_{w}$ e calcular sua variância sob o plano amostral realmente utilizado (amostragem estratificada simples - AES - com alocação igual, mas desproporcional). Essa variância poderá então ser comparada com o valor esperado (sob a distribuição induzida pelo plano amostral estratificado) do estimador da variância obtido sob a hipótese de amostragem aleatória simples.

Neste exemplo, a variância do estimador $\overline{y}_w$ pode ser obtida de duas formas: calculando a expressão da variância utilizando os dados de todas as unidades da população (que são conhecidos, mas admitidos desconhecidos para fins do exercício de estimação de médias via amostragem) e por simulação.

A variância de $\overline{y}_w$ sob a distribuição de aleatorização do plano amostral 'verdadeiro' - AES - é dada por - ver a seção 11.2.3 de @Silva2020:


\begin{equation}
V_{AES} \left( \overline{y}_w \right) = \sum\limits_{h=1}^2 W_h^2 \left( \frac{1}{n_h} - \frac{1}{N_h} \right) S_h^2 \quad (\#eq:eqC4N4)
\end{equation}

onde $S_h^2 = \frac{1}{N_h - 1} \sum_{i \in U_h} \left(y_i - \overline{Y}_h \right)^2$ é a variância populacional da variável de pesquisa $y$ dentro do estrato $h$.

Conforme a seção 11.2.3 de @Silva2020, esta variância pode ser estimada sem viés sob AES usando o estimador


\begin{equation}
\widehat{V}_{AES} \left( \overline{y}_w \right) = \sum\limits_{h=1}^2 W_h^2 \left( \frac{1}{n_h} - \frac{1}{N_h} \right) \widehat{S}_h^2 \quad (\#eq:eqC4N5)
\end{equation}

onde $\widehat{S}_h^2 = \frac{1}{n_h - 1} \sum_{i \in s_h} (y_i - \overline{y}_h)^2$.

Um estimador ingênuo da variância de $\overline{y}$ que seria usado sob amostragem aleatória simples é dado por

$$
v_{0} = \left( \frac{1}{n}  - \frac{1}{N} \right) \widehat{S}^2
$$
onde $\widehat{S}^2 = \frac{1}{n-1} \sum\limits_{h=1}^2 \sum_{i \in s_{h}} \left(y_i - \overline{y} \right)^2$.

Note que tanto o estimador média amostral simples $\overline{y}$ como o correspondente estimador de variância $v_{0}$ devem ser viciados no contexto da amostragem estratificada proposta neste exemplo. Mas a ideia do exemplo é justamente ilustrar os problemas que surgem quando se adota uma inferência padrão, dependente das hipóteses de observações IID (ou de AASC), como a que está disponível nos sistemas padrões de análise de dados, sem levar em conta os aspectos do plano amostral de fato usado para obtenção dos dados considerados na análise.

O valor do $EPA$ foi também estimado por meio de simulação. O motivo para usar simulação é que a obtenção do valor esperado sob AES de $v_{0}$ de forma analítica é trabalhosa. Geramos então $500$ amostras de tamanho $n=60$, segundo o plano amostral estratificado considerado. Para cada uma das $500$ amostras e cada uma das duas variáveis de pesquisa (SAL e REC) foram calculadas as estatísticas:

1.  média amostral ($\overline{y}$);

2.  estimativa ponderada da média populacional ($\overline{y}_{w}$);

3.  estimativa da variância da estimativa ponderada da média ($\overline{y}$) considerando observações IID $v_{0}$;

4.  estimativa da variância da estimativa ponderada da média ($\overline{y}_{w}$) considerando o plano amostral verdadeiro $\hat{V}_{AES} \left( \overline{y}_{w} \right)$.


Note que na apresentação dos resultados os valores dos salários foram expressos em milhares de Reais (R\$ $1.000,00$) e os valores das receitas em milhões de Reais (R\$ $1.000.000,00$). Como a população é conhecida, os parâmetros populacionais de interesse podem ser calculados, obtendo-se os valores na primeira linha da Tabela \@ref(tab:tabC4N3).



\begin{table}[H]

\caption{(\#tab:tabC4N3)$\text{Propriedades dos estimadores da média das variáveis de pesquisa}$}
\centering
\begin{tabular}[t]{lrr}
\toprule
Quantidade de interesse & Salários & Receitas\\
\midrule
Média Populacional & 78,3 & 2,11\\
Média de estimativas de média AAS & 163,3 & 4,18\\
Média de estimativas de média AES & 77,8 & 2,10\\
\bottomrule
\end{tabular}
\end{table}


Em contraste com os valores dos parâmetros populacionais, calculamos a média das médias amostrais não ponderadas ($\overline{y}$) dos salários e das receitas obtidas nas $500$ amostras simuladas, obtendo os valores na segunda linha da Tabela \@ref(tab:tabC4N3). Como previsto, observamos um viés para cima na estimação das médias populacionais, da ordem de $108,5\%$ para os salários e de $98,1\%$ para as receitas, demonstrando o que era esperado e o quanto seria inadequado neste exemplo ignorar os pesos amostrais na estimação da média populacional.


XXX Rever estes parágrafos após calcular erros padrões e estatísticas t de teste
XXX para o vício do estimador média ponderada

Usamos também o estimador $\overline{y}_{w}$ para estimar a média dos salários e das receitas na população, obtendo para esse estimador as médias apresentadas na terceira linha da Tabela \@ref(tab:tabC4N3). Observamos ainda um pequeno vício relativo da ordem de $-0,6\%$ e $-0,5\%$ para os salários e receitas, respectivamente.

Note que o estimador $\overline{y}_{w}$ é não viciado sob o plano amostral adotado, entretanto o pequeno vício observado na simulação não pode ser ignorado pois é significantemente diferente de $0$ ao nível de significância de $5\%$, apesar do tamanho razoável da simulação ($500$ replicações).

XXX

Além das estimativas pontuais, o interesse maior da simulação foi comparar valores de estimativas de variância e, consequentemente, de medidas do efeito do plano amostral. Como o estimador pontual dado pela média amostral não ponderada ($\overline{y}$) é grosseiramente viciado, não consideramos estimativas de variância para esse estimador, mas tão somente para o estimador não viciado dado pela média ponderada $\overline{y}_{w}$. Para esse último, consideramos dois estimadores de variância, a saber o estimador ingênuo sob a hipótese de AASC (dado por $v_{0}$, mas com o valor da estimativa de média usado no seu cálculo substituído por $\overline{y}_{w}$) e um estimador não viciado da variância sob o plano amostral AES efetivamente empregado $\hat{V}_{AES}\left( \overline{y}_{w}\right)$ dado pela expressão \@ref(eq:eqC4N5).

Como neste exercício a população é conhecida, podemos calcular $V_{AES} \left( \overline{y}_{w} \right)$ através das variâncias de $y$ dentro dos estratos $h=1,2$ ou estimar essa variância através da simulação. Esses valores são apresentados respectivamente na primeira e segunda linhas da Tabela \@ref(tab:tabC4N4), para as duas variáveis de pesquisa consideradas.

\begin{table}[H]

\caption{(\#tab:tabC4N4)$\text{Propriedades dos estimadores de variância do estimador ponderado da média}$}
\centering
\begin{tabular}[t]{lrr}
\toprule
Quantidade de interesse & Salários & Receitas\\
\midrule
Variância do estimador AES & 244 & 0,435\\
Média de estimativas de variância AES & 243 & 0,505\\
Valor esperado AES do estimador AAS de variância & 1.613 & 1,188\\
Média de estimativas de variância AAS & 1.714 & 1,242\\
\bottomrule
\end{tabular}
\end{table}

Os valores de $E_{VERD} \left[ v_{0} \left( \overline{SAL}_{w} \right) \right]$ e de $E_{VERD} \left[ v_{0} \left( \overline{REC}_{w} \right) \right]$ foram também calculados a partir das variâncias dentro e entre estratos na população, resultando nos valores na linha 3 da Tabela \@ref(tab:tabC4N4), e estimativas desses valores baseadas nas $500$ amostras da simulação são apresentadas na linha 4 da Tabela  \@ref(tab:tabC4N4). Os valores para o $EPA$ foram calculados tanto com base nas estimativas de simulação como nos valores populacionais das variâncias, cujos cálculos estão ilustrados a seguir:


$EPA\left[ \overline{SAL}_{w}, v_0 \left(\overline{SAL}_{w} \right)\right] =$


```
## 242,792358381168/1713,8055430219=0,142
```


$EPA\left[ \overline{REC}_{w},v_{0} \left( \overline{REC}_{w} \right) \right] =$



```
## 0,505416004004538/1,24157646252246=0,407
```

$EPA\left[ \overline{SAL}_{w}, v_{0} \left( \overline{SAL}_{w} \right) \right] =$


```
## 244,17580090709/1613,3=0,151
```

$EPA\left[ \overline{REC}_{w}, v_{0} \left( \overline{REC}_{w} \right) \right] =$


```
## 0,434994493392157/1,188=0,366
```


A Tabela \@ref(tab:tabC4N5) resume os principais resultados deste exercício, para o estimador ponderado da média $\overline{y}_{w}$. Apesar das diferenças entre os resultados da simulação e suas contrapartidas calculadas considerando conhecidos os valores da população, as conclusões da análise são similares:


1.  ignorar os pesos na estimação da média provoca vícios substanciais, que não podem ser ignorados; portanto, o uso do estimador simples de média ($\overline{y}$) é desaconselhado;

2.  ignorar os pesos na estimação da variância do estimador ponderado $\overline{y}_{w}$ também provoca vícios substanciais, neste caso, superestimando a variância por ignorar o efeito de estratificação; os efeitos de plano amostral são substancialmente menores que $1$ para as duas variáveis de pesquisa consideradas (salários e receita); portanto o uso do *estimador ingênuo* de variância $v_{0}$ é desaconselhado.


Essas conclusões são largamente aceitas pelos amostristas e produtores de dados baseados em pesquisas amostrais para o caso da estimação de médias e totais, e respectivas variâncias. Entretanto, ainda há exemplos de usos indevidos de dados amostrais nos quais os pesos e outros aspectos importantes dos planos amostrais complexos de fato empregados para obter os dados são ignorados nas análises, em particular para a estimação de variâncias associadas a estimativas pontuais de médias e de parâmetros de modelos. Tal situação se deve ao uso ingênuo de sistemas estatísticos padrões desenvolvidos para analisar amostras IID, sem a devida consideração dos pesos e outros aspectos da estrutura do plano amostral empregado para obtenção dos dados.


\begin{table}[H]

\caption{(\#tab:tabC4N5)$\text{Valores dos Efeitos de Plano amostral - EPA para as médias de Salário e Receita}$}
\centering
\begin{tabular}[t]{llrr}
\toprule
Variável & Estimativa & Simulação & População\\
\midrule
Salário & Variância & 242,792 & 244,176\\
Salário & EPA & 0,142 & 0,151\\
Receita & Variância & 0,505 & 0,435\\
Receita & EPA & 0,407 & 0,366\\
\bottomrule
\end{tabular}
\end{table}

**Observação. ** Neste exemplo não foi feito uso analítico dos dados e sim descritivo, onde é usual incorporar os pesos no cálculo de estimativas e variâncias. Não seria esperado usar um estimador ponderado para a média e não considerar os pesos no cálculo de variâncias, como fizemos neste exemplo.   


**Observação. ** O exemplo mostra que ignorar a estratificação ao calcular $v_{0}$ diminui o $EPA$.    


Um outro exemplo relevante é utilizado a seguir para ilustrar o fato de que o conceito do $EPA$ adotado aqui é mais abrangente do que o definido por @Kish65, em particular porque a origem do efeito pode estar na estrutura da população e não no plano amostral usado para obter os dados.

\BeginKnitrBlock{example}
<span class="example" id="exm:exe43"><strong>(\#exm:exe43) </strong></span>População conglomerada com conglomerados de tamanho 2 - @SHS89, p. 25
\EndKnitrBlock{example}

Considere uma população de unidades agrupadas em conglomerados de tamanho $2$, isto é, onde as unidades (elementares ou de referência) estão grupadas em pares (exemplos de tais populações incluem pares de irmãos gêmeos, casais, jogadores numa dupla de vôlei de praia ou de tênis, etc.). Suponha que os valores de uma variável de pesquisa medida nessas unidades têm média $\theta$ e variância $\sigma^{2}$, além de uma correlação $\rho$ entre os valores dentro de cada par (correlação intraclasse, veja @SilvaMou, cap. 2 e @haggard). Suponha que um único par é sorteado ao acaso da população e que os valores $y_{1}$ e $y_{2}$ são observados para as duas unidades do par selecionado. O modelo assumido $M$ pode então ser representado como

$$
M =
\left\{
\begin{array}{l}
E_{M}\left( Y_{i}\right) =\theta \\
V_{M}\left( Y_{i}\right) =\sigma ^{2} \\
CORR_{M}\left( Y_{1};Y_{2}\right) =\rho
\end{array}
\right. \;\;i=1,2.
$$

Um estimador não viciado para $\theta$ é a média amostral dada por $\widehat{\theta } = (y_{1}+y_{2})/2$. Assumindo a (falsa) hipótese de que o esquema amostral é AASC de unidades individuais e não de pares ou, equivalentemente, que $y_{1}$ e $y_{2}$ são observações de variáveis aleatórias IID, a variância de $\widehat{\theta}$ é dada por
$$
V_{AASC} \left( \widehat{\theta } \right) = \sigma^{2}/2
$$
com um estimador não viciado dado por

$$
v_{0} \left( \widehat{\theta } \right) = (y_{1} - y_{2})^{2}/4
$$

Entretanto, na realidade a variância de $\widehat{\theta}$ é dada por

$$
V_{VERD} \left( \widehat{\theta } \right) = V_{M} \left( \widehat{\theta}
\right) = \sigma^{2} (1 + \rho)/2
$$
O valor esperado do estimador de variância $v_{0} \left( \widehat{\theta} \right)$ é dado por

$$
E_{VERD} \left[ v_{0} \left( \widehat{\theta} \right) \right] = \sigma^{2} (1 - \rho) / 2
$$

Consequentemente, considerando as equações \@ref(eq:eqC4N1) e \@ref(eq:eqC4N2), tem-se que

$$
EPA_{Kish} \left( \hat{\theta} \right) = 1 + \rho
$$
e o efeito do plano amostral ampliado é

$$
EPA \left( \hat{\theta}, v_{0} \right) = (1 + \rho) / (1 - \rho)
$$

A Figura \@ref(fig:figC4N1) mostra os valores de $EPA_{Kish} \left( \hat{\theta} \right)$ e $EPA \left( \hat{\theta}, v_{0} \right)$ para valores de $\rho$ entre $0$ e $0,8$. Como se pode notar, o efeito da especificação inadequada do plano amostral ou da estrutura populacional pode ser severo, com valores de $EPA \left( \hat{\theta} , v_{0} \right)$ chegando a $9$. Um aspecto importante a notar é que o $EPA_{Kish} \left( \hat{\theta} \right)$ tem variação muito mais modesta que o $EPA \left( \hat{\theta} , v_{0} \right)$.

![(\#fig:figC4N1)Valores de EPA e EPA de Kish para conglomeração](04-Cap04_files/figure-latex/figC4N1-1.pdf) 


Este exemplo ilustra bem dois aspectos distintos do uso de medidas como as duas propostas para avaliar o efeito de plano amostral. O primeiro é que as duas medidas são distintas, embora as respectivas estimativas baseadas numa particular amostra seriam coincidentes, conforme discutido ao apresentar o estimador na expressão \@ref(eq:eqC4N3). No caso particular deste exemplo, o $EPA_{Kish} \left( \hat{\theta} \right)$ cresce pouco com o valor do coeficiente de correlação intraclasse $\rho$, o que implica que um plano amostral conglomerado como o adotado (seleção ao acaso de um par da população) seria menos eficiente que um plano amostral aleatório simples (seleção de duas unidades ao acaso da população), mas a perda de eficiência seria modesta. Isto se dá porque os tamanhos dos conglomerados são bem pequenos - duas unidades. Já se o interesse é medir, a posteriori, o efeito da má especificação do plano amostral no estimador de variância, o impacto, medido pelo $EPA \left( \hat{\theta} , v_{0} \right)$, seria muito maior. Assim, a imprudência na estimação de variâncias (e erros padrões, intervalos de confiança, testes de significância, etc.) teria consequências bem mais sérias para as análises.

Vale ainda notar que o $EPA \left( \hat{\theta} , v_{0} \right)$ mede o impacto da má especificação do plano amostral ou do modelo para a estrutura populacional. Neste exemplo, ignorar a estrutura da população (o fato de que as observações são pareadas) poderia provocar subestimação da variância do estimador de média, que seria tanto maior quanto maior fosse o coeficiente de correlação intraclasse $\rho$. Efeitos como esse são comuns devido ao planejamento amostral, mesmo em populações onde a conglomeração é imposta artificialmente pelo amostrista.

## Efeitos sobre Intervalos de Confiança e Testes de Hipóteses Uniparamétricos {#secC4N4}
<div style="text-align: justify">

A partir da estimativa pontual $\hat{\theta}$ de um parâmetro $\theta$ (da população finita ou do modelo de superpopulação) é possível construir um intervalo de confiança de nível de confiança aproximado $\left( 1 - \alpha \right)$ a partir da distribuição assintótica de

$$
t_0 = \frac{\hat{\theta} - \theta} {v_0^{1/2}}
$$
que, sob a hipótese de que as observações são IID, tem distribuição bem aproximada pela $N(0 ; 1)$ para amostras grandes.

Neste caso, um intervalo de nível de confiança aproximado $\left( 1 - \alpha \right)$ é dado por $\left[ \hat{\theta} \mp z_{\alpha/2} v_0^{1/2} \right]$, onde $z_{\alpha/2}$ é o quantil que deixa área igual a $\alpha/2$ à sua direita sob a curva da função de densidade da distribuição normal padrão ou $N(0 ; 1)$.

Vamos agora analisar o efeito de um plano amostral complexo sobre o intervalo de confiança. Nesse caso, a distribuição que é aproximadamente normal é a da estatística pivô dada por:

$$
t = \frac{\hat{\theta} - \theta} {\left[ \widehat{V}_{VERD} \left( \hat{\theta} \right) \right]^{1/2}}
$$

Por outro lado, para obter a variância da distribuição assintótica de $t$ note que
$$
t_0 = \frac{\hat{\theta} - \theta } {v_{0}^{1/2}} = \frac{\hat{\theta} - \theta} { \left[ \widehat{V}_{VERD} \left( \hat{\theta} \right) \right]^{1/2}} \times \frac{ \left[ \widehat{V}_{VERD} \left( \hat{\theta} \right) \right] ^{1/2}}{v_{0}^{1/2}} = t \times \left[ \widehat{EPA} \left( \hat{\theta}, v_{0} \right) \right]^{1/2}
$$

Como a distribuição de $t$ tende para uma $N\left( 0;1\right)$, a variância assintótica de $t_{0}$ é aproximadamente igual ao quadrado do limite do segundo fator no lado direito da expressão, isto é, a $EPA\left( \hat{\theta}, v_0 \right)$. Logo temos que a distribuição assintótica de $t_{0}$ é dada por

$$
t_{0} \sim N \left[ 0 ; EPA \left( \hat{\theta}, v_{0} \right) \right]
$$

Dependendo do valor de $EPA \left( \hat{\theta} , v_0 \right)$, o intervalo de confiança baseado na distribuição assintótica verdadeira de $t_0$ pode ser bem distinto daquele baseado na distribuição assintótica obtida sob a hipótese de observações IID. Em geral, a probabilidade de cobertura assintótica do intervalo $\left[ \hat{\theta} \mp z_{\alpha /2} v_{0}^{1/2} \right]$ será aproximadamente igual a

$$
2 \Phi \left( z_{\alpha/2} / \left[ EPA \left( \hat{\theta} , v_0 \right) \right]^{1/2} \right) - 1
$$
onde $\Phi$ é a função de distribuição acumulada da distribuição normal padrão. Calculamos esta probabilidade para alguns valores do $EPA$, que apresentamos na Tabela \@ref(tab:tabC4N6).

\begin{table}[H]

\caption{(\#tab:tabC4N6)$\text{Probabilidades de cobertura para níveis nominais de 0,95 e 0,99}$}
\centering
\begin{tabular}[t]{ccc}
\toprule
$EPA \left( \hat{\theta}, v_0\right)$ & $1-\alpha=0,95$ & $1-\alpha=0,99$\\
\midrule
0,90 & 0,96 & 0,99\\
0,95 & 0,96 & 0,99\\
1,0 & 0,95 & 0,99\\
1,5 & 0,89 & 0,96\\
2,0 & 0,83 & 0,93\\
\addlinespace
2,5 & 0,78 & 0,90\\
3,0 & 0,74 & 0,86\\
3,5 & 0,71 & 0,83\\
4,0 & 0,67 & 0,80\\
\bottomrule
\end{tabular}
\end{table}

À medida que o valor do $EPA \left( \hat{\theta}, v_0 \right)$ aumenta, a probabilidade real de cobertura diminui, sendo menor que o valor nominal para valores de $EPA \left( \hat{\theta}, v_0 \right)$ maiores que 1, como esperado, já que nestes casos o estimador ingênuo $v_0$ subestima a variância verdadeira do estimador.

Utilizando a correspondência existente entre intervalos de confiança e testes de hipóteses, podemos derivar os níveis de significância nominais e reais subtraindo de $1$ os valores da Tabela \@ref(tab:tabC4N6). Por exemplo, para $\alpha = 0,05$ e $EPA \left( \hat{\theta}, v_0 \right) = 2$, o nível de significância real seria aproximadamente $1 - 0,83 = 0,17$.

\BeginKnitrBlock{example}
<span class="example" id="exm:exC4N4"><strong>(\#exm:exC4N4) </strong></span>Teste de hipótese sobre proporção
\EndKnitrBlock{example}
Vamos considerar um exemplo hipotético de teste de hipótese sobre uma proporção, semelhante ao de @Sud76, apresentado na p. 196 de @lethonen. Uma amostra de $m = 50$ conglomerados é extraída de uma grande população de empresas industriais (conglomerados de empregados). Suponhamos que cada empresa $i = 1, \ldots ,50$ da amostra tenha $n_{i} = 20$ empregados. O tamanho total da amostra de empregados (unidades elementares) é $n = \sum_{i \in s} n_i = 1.000$. Queremos estudar o acesso dos trabalhadores das empresas a planos de saúde.

Usando-se conhecimento do ano anterior, foi estabelecida a hipótese de que a proporção de trabalhadores cobertos por planos de saúde é $80\%$, ou seja $H_{0}: p = p_{0} = 0,8$. Vamos adotar o nível de significância $\alpha = 5\%$.

A estimativa obtida na pesquisa foi $\widehat{p} = n_A / n = 0,84$, onde $n_A = 840$ é o número de trabalhadores na amostra com acesso a planos de saúde. Ignorando o plano amostral e a conglomeração das unidades elementares na população, podemos considerar um teste binomial e usar a aproximação normal $N(0;1)$ para a estatística de teste


\begin{equation}
Z_{AASC} = |\widehat{p} - p_0| / \sqrt{p_0 \left( 1 - p_0 \right)/ n} \,\,\, (\#eq:eqC4N7)
\end{equation}

onde o denominador é o desvio padrão da estimativa $\widehat{p}$ sob a hipótese nula, e consideramos como hipótese alternativa $H_A: \, \, p \neq 0,8$.

Vamos calcular o valor da estatística $Z_{AASC}$, supondo que tenha sido usada amostragem aleatória simples com reposição (AASC) de empregados. Vamos também considerar uma abordagem baseada no plano amostral de conglomerados. O desvio padrão de $\widehat{p}$, no denominador de $Z_{AASC}$, será baseado na hipótese de distribuição binomial, com tamanhos amostrais diferentes para as duas abordagens.

Para o teste baseado na AASC, ignoramos a conglomeração e usamos na fórmula do desvio padrão do estimador $\widehat p$ da proporção o tamanho total da amostra de unidades elementares (empregados), isto é, $n = 1.000$. O valor da estatística de teste $Z_{AASC}$ definida em \@ref(eq:eqC4N7) fica, portanto, igual a

\begin{equation}
Z_{AASC} = |0,84 - 0,8| / \sqrt{0,8 \left( 1 - 0,8 \right) / 1.000} = 3,162 > z_{0,975} = 1,96 \,\,\, (\#eq:eqC4N8)
\end{equation}

onde $\sqrt{0,8 \left( 1 - 0,8 \right) / 1.000} = 0,0126$ é o desvio padrão de $\widehat{p}$ sob a hipótese nula e $z_{0,975}$ é o quantil que deixa área de $0,975$ à sua esquerda sob a densidade da distribuição normal padrão. Este resultado indica a rejeição da hipótese $H_0$ ao nível de significância estabelecido.

Por outro lado, é razoável admitir que se uma empresa oferece cobertura por plano de saúde, cada empregado dessa empresa terá acesso ao benefício. Essa é uma informação importante que foi ignorada no teste anterior. De fato, selecionar mais de uma pessoa numa empresa não aumenta nosso conhecimento sobre a cobertura por plano de saúde no local. Portanto, o *tamanho efetivo* da amostra é $\overline{n} = 50$, em contraste com o valor $1.000$ usado no teste anterior. O termo *tamanho efetivo* foi introduzido em @Kish65 para designar o tamanho de uma amostra aleatória simples necessário para estimar $p$ com a mesma precisão obtida por uma amostra conglomerada de tamanho $n$ (neste caso, igual a $1.000$) unidades elementares.

Usando o tamanho efetivo de amostra, temos a estatística de teste baseada no plano amostral verdadeiro
$$
Z_{VERD} = |\widehat{p} - p_0| / \sqrt{p_0 \left( 1 - p_0 \right) / \overline n} = |0,84 - 0,8| / \sqrt{0,8 \left( 1 - 0,8 \right) / 50} = 0,707
$$
onde o valor $\sqrt{0,8 \left( 1 - 0,8 \right) / 50} = 0,0566$ é muito maior que o valor do desvio padrão empregado no cálculo da estatística de teste $Z_{AASC}$. Em consequência, o valor observado de $Z_{VERD}$ é menor que o limite de aceitação $z_{0,975} = 1,96$, e a nova estatística de teste indica a não rejeição da mesma hipótese nula.

Neste exemplo, portanto, se verifica que ignorar a conglomeração pode induzir a uma decisão incorreta de rejeitar a hipótese nula, quando a mesma não seria rejeitada se o plano amostral de fato empregado fosse corretamente incorporado na análise. Efeitos desse tipo são mais difíceis de antecipar para inferência analítica, particularmente quando os planos amostrais empregados envolvem combinações de estratificação, conglomeração, probabilidades desiguais de seleção e calibração de pesos. Por esse motivo, a recomendação é procurar sempre considerar o plano amostral na análise, ao menos como forma de verificar se as conclusões obtidas por formas ingênuas de análise ignorando os pesos e plano amostral seriam mantidas.

## Efeitos Multivariados de Plano Amostral {#secC4N5}
<div style="text-align: justify">

O conceito de efeito de plano amostral introduzido em \@ref(eq:eqC4N2) é relativo a inferências sobre um único parâmetro $\theta$. Consideremos agora o problema de estimação de um vetor $\mathbf{\Theta}$ contendo $K$ parâmetros. Seja $\mathbf{\hat{\Theta}}$ um estimador de $\mathbf{\Theta}$ e seja $\mathbf{V}_{0}$ um estimador da matriz $K \times K$ de covariância de $\mathbf{\hat{\Theta}}$, baseado nas hipóteses de independência e igualdade de distribuição das observações - IID, ou equivalentemente, de amostragem aleatória simples com reposição - AASC. É possível generalizar a equação \@ref(eq:eqC4N2), definindo o *Efeito Multivariado do Plano Amostral* de $\mathbf{\hat{\Theta}}$ e seu estimador ingênuo de variância $\mathbf{V}_0$ como:

\begin{equation}
\mathbf{EMPA} (\mathbf{\hat{\Theta}} , \mathbf{V}_0) = \mathbf{\Delta} = \left[ E_{VERD} \left( \mathbf{V}_0 \right) \right]^{-1} \times \mathbf{V}_{VERD} (\mathbf{\hat{\Theta}}) \quad (\#eq:eqC4N9)
\end{equation}

onde $E_{VERD} \left( \mathbf{V}_0 \right)$ é o valor esperado de $\mathbf{V}_0$ e $\mathbf{V}_{VERD}(\mathbf{\hat{\Theta})}$ é a matriz de covariância de $\mathbf{\hat{\Theta}}$, ambos calculados com respeito à distribuição induzida pelo plano amostral efetivamente utilizado (verdadeiro), ou alternativamente sob o *modelo correto*.

Os autovalores $\delta_1 \geq \ldots \geq \delta_K$ da matriz $\mathbf{\Delta}$ são denominados *efeitos generalizados do plano amostral*. A partir deles, e utilizando resultados padrões de teoria das matrizes (@Johnson, p.64) é possível definir limites para os efeitos (univariados) do plano amostral para qualquer combinação linear $\mathbf{c}^{\prime} \widehat{\mathbf{\Theta}}$ das componentes de $\widehat{\mathbf{\Theta}}$. Segundo @Sk89a, pag. 43, temos os seguintes resultados:


$$
\begin{array}{ccc}
\delta_{1} & = & \max \left\{ EPA(\mathbf{c^{\prime}} \widehat{\mathbf{
\Theta}} , \mathbf{c^{\prime}}\mathbf{V}_{0}\mathbf{c)} \right\} \\
\delta_{K} & = &\min \left\{ EPA(\mathbf{c^{\prime}} \widehat{\mathbf{
\Theta}} , \mathbf{c^{\prime}}\mathbf{V}_{0}\mathbf{c)} \right\}
\end{array}
$$

No caso particular onde $\mathbf{\Delta = I}_K$, temos $\delta_1 = \ldots = \delta_K = 1$ e os *efeitos (univariados) do plano amostral* das combinações lineares para componentes de $\mathbf{\hat{\Theta}}$ são todos iguais a $1$.

Para ilustrar esse conceito, vamos reconsiderar o Exemplo \@ref(exm:exC4N2) de estimação de médias com amostragem estratificada desproporcional anteriormente apresentado, mas agora considerando a natureza multivariada do problema (há duas variáveis de pesquisa - SAL e REC).

\BeginKnitrBlock{example}
<span class="example" id="exm:exC4N5"><strong>(\#exm:exC4N5) </strong></span>Efeitos Multivariados do Plano Amostral para as médias de Salários e de Receitas
\EndKnitrBlock{example}

Vamos considerar as variáveis Salário (em R\$ $1.000$) e Receita (em R\$ $1.000.000$) definidas na população de empresas do Exemplo \@ref(exm:exC4N2) e calcular a matriz $\mathbf{EMPA}\left( \mathbf{\hat{\Theta}, V}_{0} \right)$, onde $\mathbf{\hat{\Theta} = } \left( \overline{SAL}_{w}, \overline{REC}_{w} \right)^{\prime}$. Neste exemplo, os dados populacionais são conhecidos e, portanto, podemos calcular a covariância dos estimadores $\left( \overline{SAL}_{w}, \overline{REC}_{w}\right)$. Usando a mesma notação do Exemplo \@ref(exm:exC4N2), temos que:

$$
COV_{AES} (\overline{SAL}_w , \overline{REC}_w ) = \sum\limits_{h=1}^{2} W_{h}^{2} \left(\frac{1}{n_h} - \frac{1}{N_h}\right) S_{SAL,REC}^{\left(h\right)}
$$
onde
$$
S_{SAL,REC}^{\left(h\right) } = \frac{1} {N_h - 1} \sum\limits_{i \in U_{h}} \left( SAL_i - \overline{SAL}_{h} \right) \left( REC_i - \overline{REC}_{h} \right)
$$

Substituindo os valores conhecidos na população das variáveis $SAL_i$ e $REC_i$, obtemos para esta covariância o valor
$$
COV_{AES} \left( \overline{SAL}_w , \overline{REC}_w \right) = 3,2358
$$
e portanto a matriz de variância $\mathbf{V}_{AES} \left(\overline{SAL}_w , \overline{REC}_w \right)$ dos estimadores ponderados da média fica igual a


```
       SAL  REC
SAL 244,18 3,24
REC   3,24 0,43
```

onde os valores das variâncias usadas nos cálculos com a expressão \@ref(eq:eqC4N9) foram os obtidos no Exemplo \@ref(exm:exC4N2) e coincidem, respectivamente, com os valores usados nos numeradores de $EPA\left( \overline{SAL}_w\right)$ e de $EPA\left( \overline{REC}_w\right)$ lá apresentados. Para calcular o $\mathbf{EMPA}(\mathbf{\hat{\Theta}, V}_0)$ é preciso agora obter $E_{VERD}\left(\mathbf{V}_0\right)$.

Neste exemplo, a matriz de efeito do plano amostral $\mathbf{EMPA} \left(\mathbf{\hat{\Theta} , V}_0 \right) = \mathbf{\Delta}$ pode também ser calculada através de simulação, de modo análogo ao que foi feito no Exemplo \@ref(exm:exC4N2). Para isto, foram utilizadas as $500$ amostras de tamanho $60$ segundo o plano amostral descrito no Exemplo \@ref(exm:exC4N2). Para cada uma das $500$ amostras foram calculadas estimativas:


1.  da variância da média amostral ponderada do salário e da receita assumindo observações IID;

2.  da covariância entre médias ponderadas do salário e da receita assumindo observações IID;

3.  da variância da média amostral ponderada do salário e da receita considerando o plano amostral verdadeiro;

4.  da covariância entre médias ponderadas do salário e da receita considerando o plano amostral verdadeiro.


A partir da simulação foram obtidos os seguintes resultados:

- A matriz de covariância das médias amostrais ponderadas de salário e da receita, supondo observações IID  $E_{AES} \left( \mathbf{V}_0\right)$:



```
       SAL  REC
SAL 1713,8 26,3
REC   26,3  1,2
```


- A matriz de covariância das médias ponderadas de salário e da receita considerando o plano amostral verdadeiro $\mathbf{V}_{AES} \left( \mathbf{\hat{\Theta}} \right)$:



```
      SAL REC
SAL 242,8 3,1
REC   3,1 0,5
```


- A matriz $\Delta$ definida em \@ref(eq:eqC4N9)

$$
\mathbf{\Delta} = \left[ E_{AES} \left(\mathbf{V}_0 \right) \right]^{-1}  \times \mathbf{V}_{AES} (\hat{\theta})
$$


```
        sal      rec
[1,]  0,153 -0,00656
[2,] -0,740  0,54597
```


Os autovalores \text{1} e \text{1,02} de $\mathbf{\Delta}$ fornecem os efeitos generalizados do plano amostral.

Da mesma forma que o $EPA\left( \hat{\theta}, v_0 \right)$ definido em \@ref(eq:eqC4N2) para o caso uniparamétrico foi utilizado para corrigir níveis de confiança de intervalos e níveis de significância de testes, o $\mathbf{EMPA} (\mathbf{\hat{\Theta} , V}_0)$ definido em \@ref(eq:eqC4N9) pode ser utilizado para corrigir níveis de regiões de confiança e também de significância de testes de hipóteses no caso multiparamétrico. Para ilustrar, vamos considerar o problema de testar a hipótese $H_0: \mathbf{\Theta} = \mathbf{\Theta}_0$, onde $\mathbf{\Theta}$ é o vetor de médias de um vetor de variáveis de pesquisa $\mathbf{y}$. A estatística de teste usualmente adotada para este caso - ver @Johnson, p.171 - é a $T^{2}$ de Hottelling dada por

\begin{equation}
T^{2} = n \left( \mathbf{\overline{y} - \Theta}_{0} \right)^{^{\prime}} \mathbf{S}_{y}^{-1} \left( \mathbf{\overline{y} - \Theta}_{0} \right) \,\,\, (\#eq:eqC4N10)
\end{equation}

onde:

$$
\begin{array}{ccl}
\, \mathbf{\overline y} & = & \frac{1}{n} \sum_{i \in s} \mathbf{y}_{i} \\ \mathbf{S}_{y} & = & \frac{1}{n-1} \sum_{i \in s} \left( \mathbf{y}_{i} - \mathbf{\overline{y}} \right) \left( \mathbf{y}_{i} - \mathbf{\overline{y}} \right)^{^{\prime }} \\ \mathbf{\Theta}_{0} & = & \left( \theta _{0;1}, \theta _{0;2}, \ldots , \theta _{0;K} \right)^{^{\prime}} \;\;
\end{array}
$$

Sob $H_0$, se as observações $\mathbf{y}_{i}$ forem IID normais, a estatística $T^2$ tem a distribuição $\frac{ (n - 1)K } { n - K } F{\left( K ; n - K \right)}$, onde $F{\left( K ; n - K \right)}$ denota uma variável aleatória com distribuição $F$ com $K$ e $\left(n - K\right)$ graus de liberdade. Mesmo se as observações $\mathbf{y}_i$ não tiverem distribuição normal, $T^2$ tem distribuição assintótica $\chi^{2} \left( K \right)$ quando $n \rightarrow \infty$, @Johnson, p.191.

Contudo, se for utilizado um plano amostral complexo, $T^2$ tem aproximadamente a distribuição da variável $\sum_{k=1}^K \delta_k Z_k^{2}$, onde $Z_1, \ldots , Z_K$ são variáveis aleatórias independentes com distribuição normal padrão e os $\delta_k$ são os autovalores da matriz $\mathbf{\Delta} = \mathbf{\Sigma}_{AASC}^{-1} \mathbf{\Sigma}_p$, onde $\mathbf{\Sigma}_{AASC} = E_p (\mathbf{S}_y/n)$ e $\mathbf{\Sigma}_p = V_p (\mathbf{\overline{y})}$.

Vamos analisar o efeito do plano amostral sobre o nível de significância deste teste. Para simplificar, consideremos o caso em que $\delta_1 = \ldots = \delta_K = \delta$. Neste caso, o nível de significância real é dado aproximadamente por

\begin{equation}
P \left(T^2 > \chi_{\alpha }^{2} \left( K \right) / \delta \right) \quad (\#eq:eqC4N11)
\end{equation}

onde $\chi_{\alpha}^{2}\left(K\right)$ é o quantil superior $\alpha$ de uma distribuição $\chi^2$ com $K$ graus de liberdade, isto é, o valor tal que $P\left[ \chi^2\left(K\right) > \chi_{\alpha}^2 \left(K\right) \right] = \alpha$ .

A Tabela \@ref(tab:tabC4N7) apresenta os níveis de significância reais para $\alpha = 5\%$ para vários valores de $K$ e $\delta$. Mesmo quando os valores dos $\delta_k$ são distintos, os valores da Tabela \@ref(tab:tabC4N7) podem ser devidamente interpretados. Para isso, consideremos o valor-$p$ do teste da hipótese $H_{0}: \mathbf{\Theta }=\mathbf{\Theta}_{0}$, sob a hipótese de AASC e sob o plano amostral efetivamente utilizado. Por definição este valor é dado por

$$
\mbox{valor-}p_{AASC} \left( \mathbf{\overline{y}} \right) = P\left[ \chi^{2} \left( K \right) > \left( \mathbf{\overline{y} - \Theta}_{0} \right)^{{\prime}} \mathbf{\Sigma}_{AASC}^{-1} \left( \mathbf{\overline{y} - \Theta}_{0} \right) \right]
$$
e $H_0$ é rejeitada com nível de significância $\alpha$ se $\mbox{valor-}p_{AASC} < \alpha$.

O verdadeiro $\mbox{valor-}p_{AASC}$ pode ser definido analogamente como

\begin{equation}
\mbox{valor-}p_{VERD} \left( \mathbf{\overline{y}} \right) = P\left[ \chi^{2} \left( K \right) > \left( \mathbf{\overline{y} - \Theta}_0 \right)^{\prime} \mathbf{\Sigma}_{VERD}^{-1} \left( \mathbf{\overline{y} - \Theta}_0 \right) \right] \quad (\#eq:eqC4N12)
\end{equation}

Os valores na Tabela \@ref(tab:tabC4N7)  podem ser usados para quantificar a diferença entre estes valores-$p$. Consideremos a região crítica do teste de nível $\alpha$ baseado na hipótese de AASC:

\begin{equation}
\begin{array}{ccl}
RC_{AASC}\left( \mathbf{\overline{y}}\right) &=& \left\{ \mathbf{\overline{y}:} \quad \left(
\mathbf{\overline{y} - \Theta }_0\right)^{\prime } \mathbf{\Sigma}_{AASC}^{-1} \left( \mathbf{\overline{y} - \Theta}_0\right) > \chi_{\alpha}^2 \left(K\right) \right\} \quad (\#eq:eqC4N13) \\
&=&\left\{ \mathbf{\overline{y}:} \quad \mbox{valor-}p_{AASC} \left(\mathbf{\overline{y}} \right) < \alpha \right\}
\end{array}
\end{equation}


Pode-se mostrar - ver @Sk89a, pag. 43 - que o máximo de $\text{valor-}p_{VERD} \left(\mathbf{\overline{y}}\right)$ quando $\mathbf{\overline{y}}$ pertence à $RC_{AASC}\left(\mathbf{\overline{y}}\right)$ é dado por:

\begin{equation}
\max_{\mathbf{\overline{y}} \in RC_{AASC} \left( \mathbf{\overline{y}}\right) } \mbox{valor-}p_{VERD} \left(\mathbf{\overline{y}}\right) = P \left[ \chi^2(K) > \chi_{\alpha}^2(K) / \delta _{1} \right] \quad (\#eq:eqC4N14)
\end{equation}

Observe que o segundo membro de \@ref(eq:eqC4N14) é da mesma forma que o segundo membro de \@ref(eq:eqC4N11). Logo, os valores da Tabela \@ref(tab:tabC4N7) podem ser interpretados como valores máximos $\mbox{valor-}p_{VERD} \left(\mathbf{\overline{y}}\right)$ para $\mathbf{\overline{y}}$ na região $RC_{AASC}\left(\mathbf{\overline{y}}\right)$, considerando-se $\delta_{1}$ no lugar de $\delta$.

\begin{table}[H]

\caption{(\#tab:tabC4N7)\centering $\text{Níveis de significância verdadeiros, em porcentagem, do teste } T^2 \text{ para o nível nominal}$ \newline $\text{de 5 por cento  assumindo autovalores iguais a }\delta$}
\centering
\begin{tabular}[t]{>{\centering\arraybackslash}p{2cm}>{\raggedleft\arraybackslash}p{2cm}>{\raggedleft\arraybackslash}p{2cm}>{\raggedleft\arraybackslash}p{2cm}>{\raggedleft\arraybackslash}p{2cm}}
\toprule
$\delta$ & K=1 & K=2 & K=3 & K=4\\
\midrule
0,9 & 4 & 4 & 3 & 3\\
1,0 & 5 & 5 & 5 & 5\\
1,5 & 11 & 14 & 16 & 19\\
2,0 & 17 & 22 & 27 & 32\\
2,5 & 22 & 30 & 37 & 44\\
\addlinespace
3,0 & 26 & 37 & 46 & 53\\
\bottomrule
\end{tabular}
\end{table}




Os valores apresentados na Tabela \@ref(tab:tabC4N7) mostram que, mesmo quando os efeitos do plano amostral são modestos (valores iguais a 1,5, por exemplo) os níveis de significância reais são bem maiores que o nível nominal especificado. Além disso, esses níveis crescem rapidamente com o número de parâmetros $K$ considerados na estatística de teste. Vale então reforçar o alerta aos analistas de dados para que não deixem de levar em conta o plano amostral empregado para obter os dados usados em suas análises, sob pena de tomarem decisões incorretas com frequências muito acima das que seriam aceitáveis em aplicações dos testes de hipóteses considerados.

## Laboratório de R {#secC4N6}
<div style="text-align: justify">

Utilizando o R, obtemos a seguir alguns resultados descritos nos Exemplos \@ref(exm:exC4N2) e \@ref(exm:exC4N5). Na simulação, usamos o pacote *sampling*, @R-sampling, para gerar amostras estratificadas de tamanho $n=60$, com estratos definidos na Tabela \@ref(tab:tabC4N2), para obter os valores nas Tabelas \@ref(tab:tabC4N3) e \@ref(tab:tabC4N4).



```r
# carrega library
library(survey)
# carrega dados
#library(anamco)
popul_dat <- readRDS(file = 'data/popul.rds') # carrega dados
N <- nrow(popul_dat)
n1 <- 30
n2 <- 30
nh = c(n1, n2)
n <- sum(nh)
Nh <- table(popul_dat$estrat)
fh <- nh/Nh
Wh <- Nh/N
f <- n/N
popul_dat$sal <- popul_dat$sal/1000
popul_dat$rec <- popul_dat$rec/1e+06
library(sampling)
# define espaços para salvar resultados
est_aas <- c(0, 0)
est_aes <- c(0, 0)
cov_mat_aas_est <- matrix(0, 2, 2)
cov_mat_aes_est <- matrix(0, 2, 2)
set.seed(123)
# gera amostras com dois estratos de tamanho 30
for (i in 1:500) {
  s <- strata(popul_dat, "estrat", c(30, 30), method = "srswor")
  dados <- getdata(popul_dat, s)
  # média amostral de salário e de receita
  est_aas <- est_aas + c(mean(dados$sal), mean(dados$rec))
  # estimador v0
  cov_mat_aas_est <- cov_mat_aas_est + (1 - f) * cov(cbind(dados$sal, 
    dados$rec))/n
  
  # vhat_aes estimador não viciado
  popul_plan <- svydesign(~1, strata = ~estrat, data = dados, 
    fpc = ~Prob)
  # estimador não viciado da média de salario e receita
  sal_rec_aes_est <- svymean(~sal + rec, popul_plan)
  est_aes <- est_aes + coef(sal_rec_aes_est)
  cov_mat_aes_est <- cov_mat_aes_est + attr(sal_rec_aes_est, 
    "var")
}

# média populacional
med_pop <- round(c(mean(popul_dat$sal), mean(popul_dat$rec)), 3)


# Calcula médias das estimativas na simulação

## Média das estimativas pontuais para as 500 amostras aas
mean_est_aas <- round(est_aas/500,3)
mean_est_aas
```

```
## [1] 163,30   4,18
```

```r
## Média das estimativas pontuais para as 500 amostras aes
mean_est_aes <- round(est_aes/500,3)
mean_est_aes
```

```
##  sal  rec 
## 77,8  2,1
```

```r
# Média das estimativas de matriz de covariância para as 500
# amostras aas
mean_cov_mat_aas_est <- round(cov_mat_aas_est/500, 3)
mean_cov_mat_aas_est
```

```
##        [,1]  [,2]
## [1,] 1713,8 26,28
## [2,]   26,3  1,24
```

```r
# Média das estimativas de matriz de covariância para as 500
# amostras aes
mean_cov_mat_aes_est <- round(cov_mat_aes_est/500, 3)
mean_cov_mat_aes_est
```

```
##       sal   rec
## sal 242,8 3,103
## rec   3,1 0,505
```

```r
## Matriz de covariância populacional
mat_cov_pop <- by(popul_dat, popul_dat$estrat, function(t) var(cbind(t$sal, 
  t$rec)))
 


## Matriz de covariância considerando o plano amostral
## verdadeiro
mat_cov_aleat_verd <- (Wh[1]^2 * (1 - fh[1])/nh[1]) * mat_cov_pop[[1]] + 
  (Wh[2]^2 * (1 - fh[2])/nh[2]) * mat_cov_pop[[2]]
mat_cov_aleat_verd <- round(mat_cov_aleat_verd,3)


## estimativa de efeitos generalizados do plano amostral
DELTA = solve(mean_cov_mat_aas_est) %*% mean_cov_mat_aes_est
epa <-round(eigen(DELTA)$values,3)
```

\BeginKnitrBlock{example}
<span class="example" id="exm:eqmean"><strong>(\#exm:eqmean) </strong></span>Teste da igualdade de médias para duas populações
\EndKnitrBlock{example}

Para exemplificar o material descrito na Seção \@ref(secC4N4), vamos utilizar o data frame `amolim`, contendo dados da `Amostra do Censo Experimental de Limeira`.


```r
# Carrega dados
amolim <- readRDS("./data/amolim.rds")
dim(amolim)
```

```
## [1] 706  14
```

```r
names(amolim)
```

```
##  [1] "setor"  "np"     "domic"  "sexo"   "renda"  "lrenda" "raca"   "estudo"
##  [9] "idade"  "na"     "peso"   "domtot" "peso1"  "pesof"
```
- Objeto de desenho para os dados da Amostra do Censo Experimental de Limeira:


```r
library(survey)
amolim.des <- svydesign(data=amolim,
                        id=~setor+domic,
                        weights=~pesof)
```

- Vamos estimar, a renda média por raça:


```r
svyby(~renda, ~raca, amolim.des, svymean)
```

```
##   raca  renda    se
## 1    1 110406 11262
## 2    2  73560  8207
```

- Vamos estimar, a renda média por sexo:


```r
svyby(~renda, ~sexo, amolim.des, svymean)
```

```
##   sexo  renda    se
## 1    1 108746 11696
## 2    2  40039  4042
```
- Vamos testar a igualdade de rendas por sexo:


```r
svyttest(renda ~ sexo, amolim.des)
```

```
## 
## 	Design-based t-test
## 
## data:  renda ~ sexo
## t = -6, df = 23, p-value = 0,000005
## alternative hypothesis: true difference in mean is not equal to 0
## 95 percent confidence interval:
##  -92694 -44719
## sample estimates:
## difference in mean 
##             -68707
```

- Vamos testar a igualdade de rendas por raça:


```r
svyttest(renda ~ raca, amolim.des)
```

```
## 
## 	Design-based t-test
## 
## data:  renda ~ raca
## t = -4, df = 23, p-value = 0,0006
## alternative hypothesis: true difference in mean is not equal to 0
## 95 percent confidence interval:
##  -56039 -17653
## sample estimates:
## difference in mean 
##             -36846
```


